<html dir="ltr"><head><title>Incorporate identity into your development approach - Learn :: Reader View</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <style>
html {
  overflow: overlay;
}
body {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  margin: 30px auto 0 auto;
  padding: 10px;
}
body[data-mode="light"] {
  color:  #222;
  background-color:  whitesmoke;
}
body[data-mode="dark"] {
  color:  #eee;
  background-color:  #333;
}
body[data-mode="sepia"] {
  color:  #5b4636;
  background-color:  #f4ecd8;
}
body[data-mode="solarized-light"] {
  color:  #586e75;
  background-color:  #fdf6e3;
}
body[data-mode="nord-light"] {
  color:  #2e3440;
  background-color:  #e5e9f0;
}
body[data-mode="groove-dark"] {
  color:  #cec4ac;
  background-color:  #282828;
}
body[data-mode="solarized-dark"] {
  color:  #93a1a1;
  background-color:  #002b36;
}
body[data-mode="nord-dark"] {
  color:  #e5e9f0;
  background-color:  #2e3440;
}
@media print {
  body[data-mode="light"],
  body[data-mode="dark"],
  body[data-mode="sepia"],
  body[data-mode="solarized-light"],
  body[data-mode="nord-light"],
  body[data-mode="groove-dark"],
  body[data-mode="solarized-dark"],
  body[data-mode="nord-dark"] {
    color: #000;
    background-color: #fff;
  }
}
body[data-loaded=true] {
  
}
img {
  max-width: 100%;
  height: auto;
}
body[data-images=false] canvas,
body[data-images=false] svg,
body[data-images=false] img {
  display: none;
}
a {
  color: #0095dd;
  text-decoration: none;
}
#reader-domain {
  font-family: Helvetica, Arial, sans-serif;
  text-decoration: none;
  border-bottom-color: currentcolor;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  width: 100%;
  display: inline-block;
  direction: ltr;
}
#reader-domain > span:first-child {
  font-size: 1.1em;
}
#reader-domain > span:last-child {
  font-size: 0.8em;
}
#reader-title {
  font-size: 1.6em;
  line-height: 1.25em;
  width: 100%;
  margin: 20px 0;
  padding: 0;
}
#reader-credits {
  font-size: 0.9em;
  line-height: 1.48em;
  margin: 0 0 10px 0;
  padding: 0;
  font-style: italic;
}
#reader-estimated-time {
  font-size: 0.85em;
  line-height: 1.48em;
  margin: 0 0 10px 0;
  padding: 0;
}
#reader-credits:empty {
  display: none;
}
body[data-speech="true"] .tts-box {
  position: absolute;
  left: 0;
  width: 100vw;
  height: 32px;
  z-index: 1;
  pointer-events: none;
  box-shadow: 0 0 0 1000vw rgba(128, 128, 128, 0.2);
}
body[data-speech="true"] .tts-word {
  position: absolute;
  z-index: 1;
  pointer-events: none;
  background-color: red;
  height: 2px;
}
.tts-word.hidden,
.tts-box.hidden {
  display: none;
}
body[data-speech="false"] .tts-speaking::after {
  display: none;
}
mark.hghlght {
  background-color: #ffff81;
}
</style>
  <style id="user-css">body {
  padding-bottom: 64px;
}
a:visited {
  color: #d33bf0;
}
a:link, a:link:hover, a:link:active {
  color: #0095dd;
}
a:link {
  text-decoration: none;
  font-weight: normal;
}
pre {
  white-space: pre-wrap;
}
pre code {
  background-color: #eff0f1;
  color: #393318;
  font-family: monospace;
  display: block;
  padding: 5px 10px;
}
body[data-mode="dark"] pre code {
  background-color: #585858;
  color: #e8e8e8;
}

/* CSS for sans-serif fonts */
body[data-font=sans-serif] {}
/* CSS for serif fonts */
body[data-font=serif] {}

/* CSS for "sepia" theme */
body[data-mode=sepia] {
}
/* CSS for "light" theme */
body[data-mode=light] {}
/* CSS for "dark" theme */
body[data-mode=dark] {}</style>
</head>
<body data-images="true" data-mode="sepia" data-font="sans-serif" data-loaded="true">
  <span></span> <!-- for IntersectionObserver -->
  <a id="reader-domain" href="https://docs.microsoft.com/en-gb/learn/modules/m365-identity-cultural-shift/identity-development-approach">
    <span>docs.microsoft.com</span>
    <span>/en-gb/learn/modules/m365-identity-cultural-shift/identity-development-approach</span>
  </a>
  <h1 dir="auto" id="reader-title">Incorporate identity into your development approach - Learn</h1>
  <div dir="auto" id="reader-credits">AlexandraHrt</div>
  <div dir="auto" id="reader-estimated-time">5-6 minutes</div>
  <hr>
  <div id="readability-page-1" class="page"><div id="unit-inner-section">
		
		
		<ul>
			<li>10 minutes</li>
		</ul>
			<p>Signals generated by and fed to Identity Protection can be further fed into tools like Conditional Access to make access decisions or fed back to a security information and event management (SIEM) tool for further investigation based on your organization's enforced policies. Microsoft Graph APIs also allow organizations to collect data from Identity Protection for further processing.</p>
<p>Microsoft Graph is the Microsoft unified API endpoint and the home of Azure Active Directory Identity Protection APIs. There are three APIs that expose information about risky users and sign-ins.</p>
<ul>
<li>The first API, <strong>riskDetection</strong>, allows you to query Microsoft Graph for a list of both user and sign-in linked risk detections.</li>
<li>The second API, <strong>riskyUsers</strong>, allows you to query Microsoft Graph for information about users that Identity Protection detected as risky.</li>
<li>The third API, <strong>sign in</strong>, allows you to query Microsoft Graph for information on sign-ins with specific properties related to risk state, detail, and level.</li>
</ul>
<p>To query Identity Protection APIs, an application must be created within Azure AD with the appropriate permissions:</p>
<ol>
<li><p>Start by registering an application:</p>
<p><img src="https://docs.microsoft.com/en-gb/learn/m365/m365-identity-cultural-shift/media/register.png" alt="Registering an application screen" data-linktype="relative-path"></p>
</li>
<li><p>Select API permissions under the newly registered application. Select <strong>Microsoft Graph and Application permissions</strong>. Then select the <strong>IdentityRiskEvent.Read.All permission</strong>:</p>
<p><img src="https://docs.microsoft.com/en-gb/learn/m365/m365-identity-cultural-shift/media/application-permissions.png" alt="Microsoft Graph and Application permissions screen" data-linktype="relative-path"></p>
</li>
<li><p>Once the permissions are provided to the application, select <strong>Certificates &amp; secrets</strong> and create a new <strong>client secret</strong> with <strong>1 year</strong> expiration.</p>
<p><img src="https://docs.microsoft.com/en-gb/learn/m365/m365-identity-cultural-shift/media/aadip-risk-event.png" alt="Add a client secret screen" data-linktype="relative-path"></p>
</li>
</ol>
<p>With the information collected from these steps, you can now collect information on the Azure AD Identity Protection events of your users. The following script is a sample PowerShell script for collecting identity risk detections:</p>
<pre tabindex="0"><code data-author-content="$ClientID       = &quot;<your client ID here>&quot;        # Should be a ~36 hex character string; insert your info here
$ClientSecret   = &quot;<your client secret here>&quot;    # Should be a ~44 character string; insert your info here
$tenantdomain   = &quot;<your tenant domain here>&quot;    # For example, contoso.onmicrosoft.com

$loginURL       = &quot;https://login.microsoft.com&quot;
$resource       = &quot;https://graph.microsoft.com&quot;

$body       = @{grant_type=&quot;client_credentials&quot;;resource=$resource;client_id=$ClientID;client_secret=$ClientSecret}
$oauth      = Invoke-RestMethod -Method Post -Uri $loginURL/$tenantdomain/oauth2/token?api-version=1.0 -Body $body

Write-Output $oauth

if ($oauth.access_token -ne $null) {
        $headerParams = @{'Authorization'=&quot;$($oauth.token_type) $($oauth.access_token)&quot;}

        $url = &quot;https://graph.microsoft.com/beta/identityRiskEvents&quot;
        Write-Output $url

        $myReport = (Invoke-WebRequest -UseBasicParsing -Headers $headerParams -Uri $url)

        foreach ($event in ($myReport.Content | ConvertFrom-Json).value) {
            Write-Output $event
        }

} else {
        Write-Host &quot;ERROR: No Access Token&quot;
}
"><span><span>$ClientID</span>       = <span>"&lt;your client ID here&gt;"</span>        <span># Should be a ~36 hex character string; insert your info here</span>
<span>$ClientSecret</span>   = <span>"&lt;your client secret here&gt;"</span>    <span># Should be a ~44 character string; insert your info here</span>
<span>$tenantdomain</span>   = <span>"&lt;your tenant domain here&gt;"</span>    <span># For example, contoso.onmicrosoft.com</span>

<span>$loginURL</span>       = <span>"https://login.microsoft.com"</span>
<span>$resource</span>       = <span>"https://graph.microsoft.com"</span>

<span>$body</span>       = @{grant_type=<span>"client_credentials"</span>;resource=<span>$resource</span>;client_id=<span>$ClientID</span>;client_secret=<span>$ClientSecret</span>}
<span>$oauth</span>      = <span>Invoke-RestMethod</span><span> -Method</span> Post<span> -Uri</span> <span>$loginURL</span>/<span>$tenantdomain</span>/oauth2/token?<span>api-version</span>=<span>1.0</span><span> -Body</span> <span>$body</span>

<span>Write-Output</span> <span>$oauth</span>

<span>if</span> (<span>$oauth</span>.access_token<span> -ne</span> <span>$null</span>) {
        <span>$headerParams</span> = @{<span>'Authorization'</span>=<span>"$(<span>$oauth</span>.token_type) $(<span>$oauth</span>.access_token)"</span>}

        <span>$url</span> = <span>"https://graph.microsoft.com/beta/identityRiskEvents"</span>
        <span>Write-Output</span> <span>$url</span>

        <span>$myReport</span> = (<span>Invoke-WebRequest</span><span> -UseBasicParsing</span><span> -Headers</span> <span>$headerParams</span><span> -Uri</span> <span>$url</span>)

        <span>foreach</span> (<span>$event</span> <span>in</span> (<span>$myReport</span>.Content | <span>ConvertFrom-Json</span>).value) {
            <span>Write-Output</span> <span>$event</span>
        }

} <span>else</span> {
        <span>Write-Host</span> <span>"ERROR: No Access Token"</span>
}
</span></code></pre>
<p>You can also use the Microsoft Graph Explorer to query the same information. When you first sign in to the Graph Explorer, you're required to accept permissions to run queries. If you had previously accepted the permissions, you can find the new IdentityRiskEvent read permissions under Modify permissions.</p>
<p><img src="https://docs.microsoft.com/en-gb/learn/m365/m365-identity-cultural-shift/media/modify-positions.png" alt="Microsoft Graph Explorer screen for querying the same information" data-linktype="relative-path"></p>
<p>Once you've approved the permissions for Azure AD Identity Protection APIs provided to the previously created application, you can run a query to pull the API data. For example, selecting <strong>Get, beta</strong>, and typing <strong><a href="https://graph.microsoft.com/beta/riskDetections" data-linktype="external">https://graph.microsoft.com/beta/riskDetections</a></strong> provides all the risk detections that Azure AD Identity Protection has discovered.</p>
<p><img src="https://docs.microsoft.com/en-gb/learn/m365/m365-identity-cultural-shift/media/request-body.png" alt="Once you have approved the permissions for Azure AD Identity Protection APIs provided to the previously created application, you can run a query to pull the API data." data-linktype="relative-path"></p>
<p>The following sections provide two sample scenarios and queries you can use.</p>
<h3 id="get-offline-risk-detections-riskdetection-api">Get offline risk detections (riskDetection API)</h3>
<p>With Identity Protection sign-in risk policies, you can apply conditions when risk is detected in real time. But what about detections that are discovered offline? To understand what detections occurred offline, and would not have triggered the sign-in risk policy, you can query the riskDetection API.</p>
<p><code>GET https://graph.microsoft.com/beta/riskDetections?$filter=detectionTimingType eq 'offline'</code></p>
<h3 id="get-users-who-successfully-passed-an-mfa-challenge-triggered-by-a-risky-sign-in-policy-riskyusers-api">Get users who successfully passed an MFA challenge triggered by a risky sign-in policy (riskyUsers API)</h3>
<p>To understand the impact Identity Protection risk-based policies have on your organization, you can query all the users who successfully passed an MFA challenge triggered by a risky sign-in policy. This information can help you understand which users Identity Protection may have falsely detected as at risk and which of your legitimate users may be performing actions that the AI deems risky.</p>
<p><code>GET https://graph.microsoft.com/beta/riskyUsers?$filter=riskDetail eq 'userPassedMFADrivenByRiskBasedPolicy'</code></p>

		
	</div></div>
  <span></span> <!-- for IntersectionObserver -->
  
  
  
  


</body><style>body {
      font-size:  13px;
      font-family: Helvetica, Arial, sans-serif;
      width: 600px;
    }
    .page {
      line-height: unset;
    }
    h1, h2, h3 {
      line-height: initial;
    }</style></html>